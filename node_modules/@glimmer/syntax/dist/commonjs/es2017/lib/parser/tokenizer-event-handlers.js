'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.TokenizerEventHandlers = exports.voidMap = undefined;
exports.preprocess = preprocess;

var _builders = require('../builders');

var _builders2 = _interopRequireDefault(_builders);

var _utils = require('../utils');

var _handlebarsNodeVisitors = require('./handlebars-node-visitors');

var _syntaxError = require('../errors/syntax-error');

var _syntaxError2 = _interopRequireDefault(_syntaxError);

var _traverse = require('../traversal/traverse');

var _traverse2 = _interopRequireDefault(_traverse);

var _print = require('../generation/print');

var _print2 = _interopRequireDefault(_print);

var _walker = require('../traversal/walker');

var _walker2 = _interopRequireDefault(_walker);

var _handlebars = require('handlebars');

var handlebars = _interopRequireWildcard(_handlebars);

var _util = require('@glimmer/util');

var _simpleHtmlTokenizer = require('simple-html-tokenizer');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const voidMap = exports.voidMap = Object.create(null);
let voidTagNames = 'area base br col command embed hr img input keygen link meta param source track wbr';
voidTagNames.split(' ').forEach(tagName => {
    voidMap[tagName] = true;
});
class TokenizerEventHandlers extends _handlebarsNodeVisitors.HandlebarsNodeVisitors {
    constructor() {
        super(...arguments);
        this.tagOpenLine = 0;
        this.tagOpenColumn = 0;
    }
    reset() {
        this.currentNode = null;
    }
    // Comment
    beginComment() {
        this.currentNode = _builders2.default.comment('');
        this.currentNode.loc = {
            source: null,
            start: _builders2.default.pos(this.tagOpenLine, this.tagOpenColumn),
            end: null
        };
    }
    appendToCommentData(char) {
        this.currentComment.value += char;
    }
    finishComment() {
        this.currentComment.loc.end = _builders2.default.pos(this.tokenizer.line, this.tokenizer.column);
        (0, _utils.appendChild)(this.currentElement(), this.currentComment);
    }
    // Data
    beginData() {
        this.currentNode = _builders2.default.text();
        this.currentNode.loc = {
            source: null,
            start: _builders2.default.pos(this.tokenizer.line, this.tokenizer.column),
            end: null
        };
    }
    appendToData(char) {
        this.currentData.chars += char;
    }
    finishData() {
        this.currentData.loc.end = _builders2.default.pos(this.tokenizer.line, this.tokenizer.column);
        (0, _utils.appendChild)(this.currentElement(), this.currentData);
    }
    // Tags - basic
    tagOpen() {
        this.tagOpenLine = this.tokenizer.line;
        this.tagOpenColumn = this.tokenizer.column;
    }
    beginStartTag() {
        this.currentNode = {
            type: 'StartTag',
            name: '',
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: _builders.SYNTHETIC
        };
    }
    beginEndTag() {
        this.currentNode = {
            type: 'EndTag',
            name: '',
            attributes: [],
            modifiers: [],
            comments: [],
            selfClosing: false,
            loc: _builders.SYNTHETIC
        };
    }
    finishTag() {
        let { line, column } = this.tokenizer;
        let tag = this.currentTag;
        tag.loc = _builders2.default.loc(this.tagOpenLine, this.tagOpenColumn, line, column);
        if (tag.type === 'StartTag') {
            this.finishStartTag();
            if (voidMap[tag.name] || tag.selfClosing) {
                this.finishEndTag(true);
            }
        } else if (tag.type === 'EndTag') {
            this.finishEndTag(false);
        }
    }
    finishStartTag() {
        let { name, attributes: attrs, modifiers, comments, selfClosing } = this.currentStartTag;
        let loc = _builders2.default.loc(this.tagOpenLine, this.tagOpenColumn);
        let element = _builders2.default.element({ name, selfClosing }, { attrs, modifiers, comments, loc });
        this.elementStack.push(element);
    }
    finishEndTag(isVoid) {
        let tag = this.currentTag;
        let element = this.elementStack.pop();
        let parent = this.currentElement();
        validateEndTag(tag, element, isVoid);
        element.loc.end.line = this.tokenizer.line;
        element.loc.end.column = this.tokenizer.column;
        (0, _utils.parseElementBlockParams)(element);
        (0, _utils.appendChild)(parent, element);
    }
    markTagAsSelfClosing() {
        this.currentTag.selfClosing = true;
    }
    // Tags - name
    appendToTagName(char) {
        this.currentTag.name += char;
    }
    // Tags - attributes
    beginAttribute() {
        let tag = this.currentTag;
        if (tag.type === 'EndTag') {
            throw new _syntaxError2.default(`Invalid end tag: closing tag must not have attributes, ` + `in \`${tag.name}\` (on line ${this.tokenizer.line}).`, tag.loc);
        }
        this.currentAttribute = {
            name: '',
            parts: [],
            isQuoted: false,
            isDynamic: false,
            start: _builders2.default.pos(this.tokenizer.line, this.tokenizer.column),
            valueStartLine: 0,
            valueStartColumn: 0
        };
    }
    appendToAttributeName(char) {
        this.currentAttr.name += char;
    }
    beginAttributeValue(isQuoted) {
        this.currentAttr.isQuoted = isQuoted;
        this.currentAttr.valueStartLine = this.tokenizer.line;
        this.currentAttr.valueStartColumn = this.tokenizer.column;
    }
    appendToAttributeValue(char) {
        let parts = this.currentAttr.parts;
        let lastPart = parts[parts.length - 1];
        if (lastPart && lastPart.type === 'TextNode') {
            lastPart.chars += char;
            // update end location for each added char
            lastPart.loc.end.line = this.tokenizer.line;
            lastPart.loc.end.column = this.tokenizer.column;
        } else {
            // initially assume the text node is a single char
            let loc = _builders2.default.loc(this.tokenizer.line, this.tokenizer.column, this.tokenizer.line, this.tokenizer.column);
            // the tokenizer line/column have already been advanced, correct location info
            if (char === '\n') {
                loc.start.line -= 1;
                loc.start.column = lastPart ? lastPart.loc.end.column : this.currentAttr.valueStartColumn;
            } else {
                loc.start.column -= 1;
            }
            let text = _builders2.default.text(char, loc);
            parts.push(text);
        }
    }
    finishAttributeValue() {
        let { name, parts, isQuoted, isDynamic, valueStartLine, valueStartColumn } = this.currentAttr;
        let value = assembleAttributeValue(parts, isQuoted, isDynamic, this.tokenizer.line);
        value.loc = _builders2.default.loc(valueStartLine, valueStartColumn, this.tokenizer.line, this.tokenizer.column);
        let loc = _builders2.default.loc(this.currentAttr.start.line, this.currentAttr.start.column, this.tokenizer.line, this.tokenizer.column);
        let attribute = _builders2.default.attr(name, value, loc);
        this.currentStartTag.attributes.push(attribute);
    }
    reportSyntaxError(message) {
        throw new _syntaxError2.default(`Syntax error at line ${this.tokenizer.line} col ${this.tokenizer.column}: ${message}`, _builders2.default.loc(this.tokenizer.line, this.tokenizer.column));
    }
}
exports.TokenizerEventHandlers = TokenizerEventHandlers;
function assembleAttributeValue(parts, isQuoted, isDynamic, line) {
    if (isDynamic) {
        if (isQuoted) {
            return assembleConcatenatedValue(parts);
        } else {
            if (parts.length === 1 || parts.length === 2 && parts[1].type === 'TextNode' && parts[1].chars === '/') {
                return parts[0];
            } else {
                throw new _syntaxError2.default(`An unquoted attribute value must be a string or a mustache, ` + `preceeded by whitespace or a '=' character, and ` + `followed by whitespace, a '>' character, or '/>' (on line ${line})`, _builders2.default.loc(line, 0));
            }
        }
    } else {
        return parts.length > 0 ? parts[0] : _builders2.default.text('');
    }
}
function assembleConcatenatedValue(parts) {
    for (let i = 0; i < parts.length; i++) {
        let part = parts[i];
        if (part.type !== 'MustacheStatement' && part.type !== 'TextNode') {
            throw new _syntaxError2.default('Unsupported node in quoted attribute value: ' + part['type'], part.loc);
        }
    }
    return _builders2.default.concat(parts);
}
function validateEndTag(tag, element, selfClosing) {
    let error;
    if (voidMap[tag.name] && !selfClosing) {
        // EngTag is also called by StartTag for void and self-closing tags (i.e.
        // <input> or <br />, so we need to check for that here. Otherwise, we would
        // throw an error for those cases.
        error = 'Invalid end tag ' + formatEndTagInfo(tag) + ' (void elements cannot have end tags).';
    } else if (element.tag === undefined) {
        error = 'Closing tag ' + formatEndTagInfo(tag) + ' without an open tag.';
    } else if (element.tag !== tag.name) {
        error = 'Closing tag ' + formatEndTagInfo(tag) + ' did not match last open tag `' + element.tag + '` (on line ' + element.loc.start.line + ').';
    }
    if (error) {
        throw new _syntaxError2.default(error, element.loc);
    }
}
function formatEndTagInfo(tag) {
    return '`' + tag.name + '` (on line ' + tag.loc.end.line + ')';
}
const syntax = {
    parse: preprocess,
    builders: _builders2.default,
    print: _print2.default,
    traverse: _traverse2.default,
    Walker: _walker2.default
};
function preprocess(html, options = {}) {
    let mode = options.mode || 'precompile';
    let ast;
    if (typeof html === 'object') {
        ast = html;
    } else if (mode === 'codemod') {
        ast = handlebars.parseWithoutProcessing(html, options.parseOptions);
    } else {
        ast = handlebars.parse(html, options.parseOptions);
    }
    let entityParser = undefined;
    if (mode === 'codemod') {
        entityParser = new _simpleHtmlTokenizer.EntityParser({});
    }
    let program = new TokenizerEventHandlers(html, entityParser).acceptTemplate(ast);
    if (options && options.plugins && options.plugins.ast) {
        for (let i = 0, l = options.plugins.ast.length; i < l; i++) {
            let transform = options.plugins.ast[i];
            let env = (0, _util.assign)({}, options, { syntax }, { plugins: undefined });
            let pluginResult = transform(env);
            (0, _traverse2.default)(program, pluginResult.visitor);
        }
    }
    return program;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3N5bnRheC9saWIvcGFyc2VyL3Rva2VuaXplci1ldmVudC1oYW5kbGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7UUE2WE0sVSxHQUFBLFU7Ozs7OztBQTVYTjs7QUFDQTs7QUFHQTs7OztBQUdBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztJQUFBLFU7O0FBQ0E7O0FBRUE7Ozs7OztBQUVPLE1BQU0sNEJBRVQsT0FBQSxNQUFBLENBRkcsSUFFSCxDQUZHO0FBSVAsSUFBSSxlQUFKLHFGQUFBO0FBRUEsYUFBQSxLQUFBLENBQUEsR0FBQSxFQUFBLE9BQUEsQ0FBZ0MsV0FBVTtBQUN4QyxZQUFBLE9BQUEsSUFBQSxJQUFBO0FBREYsQ0FBQTtBQUlNLE1BQUEsc0JBQUEsU0FBQSw4Q0FBQSxDQUE0RDtBQUFsRSxrQkFBQTs7QUFDVSxhQUFBLFdBQUEsR0FBQSxDQUFBO0FBQ0EsYUFBQSxhQUFBLEdBQUEsQ0FBQTtBQXdOVDtBQXROQyxZQUFLO0FBQ0gsYUFBQSxXQUFBLEdBQUEsSUFBQTtBQUNEO0FBRUQ7QUFFQSxtQkFBWTtBQUNWLGFBQUEsV0FBQSxHQUFtQixtQkFBQSxPQUFBLENBQW5CLEVBQW1CLENBQW5CO0FBQ0EsYUFBQSxXQUFBLENBQUEsR0FBQSxHQUF1QjtBQUNyQixvQkFEcUIsSUFBQTtBQUVyQixtQkFBTyxtQkFBQSxHQUFBLENBQU0sS0FBTixXQUFBLEVBQXdCLEtBRlYsYUFFZCxDQUZjO0FBR3JCLGlCQUFNO0FBSGUsU0FBdkI7QUFLRDtBQUVELHdCQUFBLElBQUEsRUFBZ0M7QUFDOUIsYUFBQSxjQUFBLENBQUEsS0FBQSxJQUFBLElBQUE7QUFDRDtBQUVELG9CQUFhO0FBQ1gsYUFBQSxjQUFBLENBQUEsR0FBQSxDQUFBLEdBQUEsR0FBOEIsbUJBQUEsR0FBQSxDQUFNLEtBQUEsU0FBQSxDQUFOLElBQUEsRUFBMkIsS0FBQSxTQUFBLENBQXpELE1BQThCLENB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QSxDQUFBLElBQUEsRUFBQSxZQUFBLEVBQUEsY0FBQSxDQUFkLEdBQWMsQ0FBZDtBQUVBLFFBQUksV0FBVyxRQUFYLE9BQUEsSUFBOEIsUUFBQSxPQUFBLENBQWxDLEdBQUEsRUFBdUQ7QUFDckQsYUFBSyxJQUFJLElBQUosQ0FBQSxFQUFXLElBQUksUUFBQSxPQUFBLENBQUEsR0FBQSxDQUFwQixNQUFBLEVBQWdELElBQWhELENBQUEsRUFBQSxHQUFBLEVBQTREO0FBQzFELGdCQUFJLFlBQVksUUFBQSxPQUFBLENBQUEsR0FBQSxDQUFoQixDQUFnQixDQUFoQjtBQUNBLGdCQUFJLE1BQU0sa0JBQUEsRUFBQSxFQUFBLE9BQUEsRUFBb0IsRUFBcEIsTUFBb0IsRUFBcEIsRUFBZ0MsRUFBRSxTQUE1QyxTQUEwQyxFQUFoQyxDQUFWO0FBRUEsZ0JBQUksZUFBZSxVQUFuQixHQUFtQixDQUFuQjtBQUVBLG9DQUFBLE9BQUEsRUFBa0IsYUFBbEIsT0FBQTtBQUNEO0FBQ0Y7QUFFRCxXQUFBLE9BQUE7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBiLCB7IFNZTlRIRVRJQyB9IGZyb20gJy4uL2J1aWxkZXJzJztcbmltcG9ydCB7IGFwcGVuZENoaWxkLCBwYXJzZUVsZW1lbnRCbG9ja1BhcmFtcyB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IEhhbmRsZWJhcnNOb2RlVmlzaXRvcnMgfSBmcm9tICcuL2hhbmRsZWJhcnMtbm9kZS12aXNpdG9ycyc7XG5pbXBvcnQgKiBhcyBBU1QgZnJvbSAnLi4vdHlwZXMvbm9kZXMnO1xuaW1wb3J0ICogYXMgSEJTIGZyb20gJy4uL3R5cGVzL2hhbmRsZWJhcnMtYXN0JztcbmltcG9ydCBTeW50YXhFcnJvciBmcm9tICcuLi9lcnJvcnMvc3ludGF4LWVycm9yJztcbmltcG9ydCB7IFRhZyB9IGZyb20gJy4uL3BhcnNlcic7XG5pbXBvcnQgYnVpbGRlcnMgZnJvbSAnLi4vYnVpbGRlcnMnO1xuaW1wb3J0IHRyYXZlcnNlIGZyb20gJy4uL3RyYXZlcnNhbC90cmF2ZXJzZSc7XG5pbXBvcnQgcHJpbnQgZnJvbSAnLi4vZ2VuZXJhdGlvbi9wcmludCc7XG5pbXBvcnQgV2Fsa2VyIGZyb20gJy4uL3RyYXZlcnNhbC93YWxrZXInO1xuaW1wb3J0ICogYXMgaGFuZGxlYmFycyBmcm9tICdoYW5kbGViYXJzJztcbmltcG9ydCB7IGFzc2lnbiB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgTm9kZVZpc2l0b3IgfSBmcm9tICcuLi90cmF2ZXJzYWwvdmlzaXRvcic7XG5pbXBvcnQgeyBFbnRpdHlQYXJzZXIgfSBmcm9tICdzaW1wbGUtaHRtbC10b2tlbml6ZXInO1xuXG5leHBvcnQgY29uc3Qgdm9pZE1hcDoge1xuICBbdGFnTmFtZTogc3RyaW5nXTogYm9vbGVhbjtcbn0gPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG5sZXQgdm9pZFRhZ05hbWVzID1cbiAgJ2FyZWEgYmFzZSBiciBjb2wgY29tbWFuZCBlbWJlZCBociBpbWcgaW5wdXQga2V5Z2VuIGxpbmsgbWV0YSBwYXJhbSBzb3VyY2UgdHJhY2sgd2JyJztcbnZvaWRUYWdOYW1lcy5zcGxpdCgnICcpLmZvckVhY2godGFnTmFtZSA9PiB7XG4gIHZvaWRNYXBbdGFnTmFtZV0gPSB0cnVlO1xufSk7XG5cbmV4cG9ydCBjbGFzcyBUb2tlbml6ZXJFdmVudEhhbmRsZXJzIGV4dGVuZHMgSGFuZGxlYmFyc05vZGVWaXNpdG9ycyB7XG4gIHByaXZhdGUgdGFnT3BlbkxpbmUgPSAwO1xuICBwcml2YXRlIHRhZ09wZW5Db2x1bW4gPSAwO1xuXG4gIHJlc2V0KCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSBudWxsO1xuICB9XG5cbiAgLy8gQ29tbWVudFxuXG4gIGJlZ2luQ29tbWVudCgpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0gYi5jb21tZW50KCcnKTtcbiAgICB0aGlzLmN1cnJlbnROb2RlLmxvYyA9IHtcbiAgICAgIHNvdXJjZTogbnVsbCxcbiAgICAgIHN0YXJ0OiBiLnBvcyh0aGlzLnRhZ09wZW5MaW5lLCB0aGlzLnRhZ09wZW5Db2x1bW4pLFxuICAgICAgZW5kOiAobnVsbCBhcyBhbnkpIGFzIEFTVC5Qb3NpdGlvbixcbiAgICB9O1xuICB9XG5cbiAgYXBwZW5kVG9Db21tZW50RGF0YShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnRDb21tZW50LnZhbHVlICs9IGNoYXI7XG4gIH1cblxuICBmaW5pc2hDb21tZW50KCkge1xuICAgIHRoaXMuY3VycmVudENvbW1lbnQubG9jLmVuZCA9IGIucG9zKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbik7XG5cbiAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIHRoaXMuY3VycmVudENvbW1lbnQpO1xuICB9XG5cbiAgLy8gRGF0YVxuXG4gIGJlZ2luRGF0YSgpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0gYi50ZXh0KCk7XG4gICAgdGhpcy5jdXJyZW50Tm9kZS5sb2MgPSB7XG4gICAgICBzb3VyY2U6IG51bGwsXG4gICAgICBzdGFydDogYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKSxcbiAgICAgIGVuZDogKG51bGwgYXMgYW55KSBhcyBBU1QuUG9zaXRpb24sXG4gICAgfTtcbiAgfVxuXG4gIGFwcGVuZFRvRGF0YShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnREYXRhLmNoYXJzICs9IGNoYXI7XG4gIH1cblxuICBmaW5pc2hEYXRhKCkge1xuICAgIHRoaXMuY3VycmVudERhdGEubG9jLmVuZCA9IGIucG9zKHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbik7XG5cbiAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIHRoaXMuY3VycmVudERhdGEpO1xuICB9XG5cbiAgLy8gVGFncyAtIGJhc2ljXG5cbiAgdGFnT3BlbigpIHtcbiAgICB0aGlzLnRhZ09wZW5MaW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICB0aGlzLnRhZ09wZW5Db2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG4gIH1cblxuICBiZWdpblN0YXJ0VGFnKCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSB7XG4gICAgICB0eXBlOiAnU3RhcnRUYWcnLFxuICAgICAgbmFtZTogJycsXG4gICAgICBhdHRyaWJ1dGVzOiBbXSxcbiAgICAgIG1vZGlmaWVyczogW10sXG4gICAgICBjb21tZW50czogW10sXG4gICAgICBzZWxmQ2xvc2luZzogZmFsc2UsXG4gICAgICBsb2M6IFNZTlRIRVRJQyxcbiAgICB9O1xuICB9XG5cbiAgYmVnaW5FbmRUYWcoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IHtcbiAgICAgIHR5cGU6ICdFbmRUYWcnLFxuICAgICAgbmFtZTogJycsXG4gICAgICBhdHRyaWJ1dGVzOiBbXSxcbiAgICAgIG1vZGlmaWVyczogW10sXG4gICAgICBjb21tZW50czogW10sXG4gICAgICBzZWxmQ2xvc2luZzogZmFsc2UsXG4gICAgICBsb2M6IFNZTlRIRVRJQyxcbiAgICB9O1xuICB9XG5cbiAgZmluaXNoVGFnKCkge1xuICAgIGxldCB7IGxpbmUsIGNvbHVtbiB9ID0gdGhpcy50b2tlbml6ZXI7XG5cbiAgICBsZXQgdGFnID0gdGhpcy5jdXJyZW50VGFnO1xuICAgIHRhZy5sb2MgPSBiLmxvYyh0aGlzLnRhZ09wZW5MaW5lLCB0aGlzLnRhZ09wZW5Db2x1bW4sIGxpbmUsIGNvbHVtbik7XG5cbiAgICBpZiAodGFnLnR5cGUgPT09ICdTdGFydFRhZycpIHtcbiAgICAgIHRoaXMuZmluaXNoU3RhcnRUYWcoKTtcblxuICAgICAgaWYgKHZvaWRNYXBbdGFnLm5hbWVdIHx8IHRhZy5zZWxmQ2xvc2luZykge1xuICAgICAgICB0aGlzLmZpbmlzaEVuZFRhZyh0cnVlKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHRhZy50eXBlID09PSAnRW5kVGFnJykge1xuICAgICAgdGhpcy5maW5pc2hFbmRUYWcoZmFsc2UpO1xuICAgIH1cbiAgfVxuXG4gIGZpbmlzaFN0YXJ0VGFnKCkge1xuICAgIGxldCB7IG5hbWUsIGF0dHJpYnV0ZXM6IGF0dHJzLCBtb2RpZmllcnMsIGNvbW1lbnRzLCBzZWxmQ2xvc2luZyB9ID0gdGhpcy5jdXJyZW50U3RhcnRUYWc7XG4gICAgbGV0IGxvYyA9IGIubG9jKHRoaXMudGFnT3BlbkxpbmUsIHRoaXMudGFnT3BlbkNvbHVtbik7XG4gICAgbGV0IGVsZW1lbnQgPSBiLmVsZW1lbnQoeyBuYW1lLCBzZWxmQ2xvc2luZyB9LCB7IGF0dHJzLCBtb2RpZmllcnMsIGNvbW1lbnRzLCBsb2MgfSk7XG4gICAgdGhpcy5lbGVtZW50U3RhY2sucHVzaChlbGVtZW50KTtcbiAgfVxuXG4gIGZpbmlzaEVuZFRhZyhpc1ZvaWQ6IGJvb2xlYW4pIHtcbiAgICBsZXQgdGFnID0gdGhpcy5jdXJyZW50VGFnO1xuXG4gICAgbGV0IGVsZW1lbnQgPSB0aGlzLmVsZW1lbnRTdGFjay5wb3AoKSBhcyBBU1QuRWxlbWVudE5vZGU7XG4gICAgbGV0IHBhcmVudCA9IHRoaXMuY3VycmVudEVsZW1lbnQoKTtcblxuICAgIHZhbGlkYXRlRW5kVGFnKHRhZywgZWxlbWVudCwgaXNWb2lkKTtcblxuICAgIGVsZW1lbnQubG9jLmVuZC5saW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICBlbGVtZW50LmxvYy5lbmQuY29sdW1uID0gdGhpcy50b2tlbml6ZXIuY29sdW1uO1xuXG4gICAgcGFyc2VFbGVtZW50QmxvY2tQYXJhbXMoZWxlbWVudCk7XG4gICAgYXBwZW5kQ2hpbGQocGFyZW50LCBlbGVtZW50KTtcbiAgfVxuXG4gIG1hcmtUYWdBc1NlbGZDbG9zaW5nKCkge1xuICAgIHRoaXMuY3VycmVudFRhZy5zZWxmQ2xvc2luZyA9IHRydWU7XG4gIH1cblxuICAvLyBUYWdzIC0gbmFtZVxuXG4gIGFwcGVuZFRvVGFnTmFtZShjaGFyOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnRUYWcubmFtZSArPSBjaGFyO1xuICB9XG5cbiAgLy8gVGFncyAtIGF0dHJpYnV0ZXNcblxuICBiZWdpbkF0dHJpYnV0ZSgpIHtcbiAgICBsZXQgdGFnID0gdGhpcy5jdXJyZW50VGFnO1xuICAgIGlmICh0YWcudHlwZSA9PT0gJ0VuZFRhZycpIHtcbiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgICAgYEludmFsaWQgZW5kIHRhZzogY2xvc2luZyB0YWcgbXVzdCBub3QgaGF2ZSBhdHRyaWJ1dGVzLCBgICtcbiAgICAgICAgICBgaW4gXFxgJHt0YWcubmFtZX1cXGAgKG9uIGxpbmUgJHt0aGlzLnRva2VuaXplci5saW5lfSkuYCxcbiAgICAgICAgdGFnLmxvY1xuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRBdHRyaWJ1dGUgPSB7XG4gICAgICBuYW1lOiAnJyxcbiAgICAgIHBhcnRzOiBbXSxcbiAgICAgIGlzUXVvdGVkOiBmYWxzZSxcbiAgICAgIGlzRHluYW1pYzogZmFsc2UsXG4gICAgICBzdGFydDogYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKSxcbiAgICAgIHZhbHVlU3RhcnRMaW5lOiAwLFxuICAgICAgdmFsdWVTdGFydENvbHVtbjogMCxcbiAgICB9O1xuICB9XG5cbiAgYXBwZW5kVG9BdHRyaWJ1dGVOYW1lKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudEF0dHIubmFtZSArPSBjaGFyO1xuICB9XG5cbiAgYmVnaW5BdHRyaWJ1dGVWYWx1ZShpc1F1b3RlZDogYm9vbGVhbikge1xuICAgIHRoaXMuY3VycmVudEF0dHIuaXNRdW90ZWQgPSBpc1F1b3RlZDtcbiAgICB0aGlzLmN1cnJlbnRBdHRyLnZhbHVlU3RhcnRMaW5lID0gdGhpcy50b2tlbml6ZXIubGluZTtcbiAgICB0aGlzLmN1cnJlbnRBdHRyLnZhbHVlU3RhcnRDb2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG4gIH1cblxuICBhcHBlbmRUb0F0dHJpYnV0ZVZhbHVlKGNoYXI6IHN0cmluZykge1xuICAgIGxldCBwYXJ0cyA9IHRoaXMuY3VycmVudEF0dHIucGFydHM7XG4gICAgbGV0IGxhc3RQYXJ0ID0gcGFydHNbcGFydHMubGVuZ3RoIC0gMV07XG5cbiAgICBpZiAobGFzdFBhcnQgJiYgbGFzdFBhcnQudHlwZSA9PT0gJ1RleHROb2RlJykge1xuICAgICAgbGFzdFBhcnQuY2hhcnMgKz0gY2hhcjtcblxuICAgICAgLy8gdXBkYXRlIGVuZCBsb2NhdGlvbiBmb3IgZWFjaCBhZGRlZCBjaGFyXG4gICAgICBsYXN0UGFydC5sb2MuZW5kLmxpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgICAgbGFzdFBhcnQubG9jLmVuZC5jb2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGluaXRpYWxseSBhc3N1bWUgdGhlIHRleHQgbm9kZSBpcyBhIHNpbmdsZSBjaGFyXG4gICAgICBsZXQgbG9jID0gYi5sb2MoXG4gICAgICAgIHRoaXMudG9rZW5pemVyLmxpbmUsXG4gICAgICAgIHRoaXMudG9rZW5pemVyLmNvbHVtbixcbiAgICAgICAgdGhpcy50b2tlbml6ZXIubGluZSxcbiAgICAgICAgdGhpcy50b2tlbml6ZXIuY29sdW1uXG4gICAgICApO1xuXG4gICAgICAvLyB0aGUgdG9rZW5pemVyIGxpbmUvY29sdW1uIGhhdmUgYWxyZWFkeSBiZWVuIGFkdmFuY2VkLCBjb3JyZWN0IGxvY2F0aW9uIGluZm9cbiAgICAgIGlmIChjaGFyID09PSAnXFxuJykge1xuICAgICAgICBsb2Muc3RhcnQubGluZSAtPSAxO1xuICAgICAgICBsb2Muc3RhcnQuY29sdW1uID0gbGFzdFBhcnQgPyBsYXN0UGFydC5sb2MuZW5kLmNvbHVtbiA6IHRoaXMuY3VycmVudEF0dHIudmFsdWVTdGFydENvbHVtbjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvYy5zdGFydC5jb2x1bW4gLT0gMTtcbiAgICAgIH1cblxuICAgICAgbGV0IHRleHQgPSBiLnRleHQoY2hhciwgbG9jKTtcbiAgICAgIHBhcnRzLnB1c2godGV4dCk7XG4gICAgfVxuICB9XG5cbiAgZmluaXNoQXR0cmlidXRlVmFsdWUoKSB7XG4gICAgbGV0IHsgbmFtZSwgcGFydHMsIGlzUXVvdGVkLCBpc0R5bmFtaWMsIHZhbHVlU3RhcnRMaW5lLCB2YWx1ZVN0YXJ0Q29sdW1uIH0gPSB0aGlzLmN1cnJlbnRBdHRyO1xuICAgIGxldCB2YWx1ZSA9IGFzc2VtYmxlQXR0cmlidXRlVmFsdWUocGFydHMsIGlzUXVvdGVkLCBpc0R5bmFtaWMsIHRoaXMudG9rZW5pemVyLmxpbmUpO1xuICAgIHZhbHVlLmxvYyA9IGIubG9jKHZhbHVlU3RhcnRMaW5lLCB2YWx1ZVN0YXJ0Q29sdW1uLCB0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pO1xuXG4gICAgbGV0IGxvYyA9IGIubG9jKFxuICAgICAgdGhpcy5jdXJyZW50QXR0ci5zdGFydC5saW5lLFxuICAgICAgdGhpcy5jdXJyZW50QXR0ci5zdGFydC5jb2x1bW4sXG4gICAgICB0aGlzLnRva2VuaXplci5saW5lLFxuICAgICAgdGhpcy50b2tlbml6ZXIuY29sdW1uXG4gICAgKTtcblxuICAgIGxldCBhdHRyaWJ1dGUgPSBiLmF0dHIobmFtZSwgdmFsdWUsIGxvYyk7XG5cbiAgICB0aGlzLmN1cnJlbnRTdGFydFRhZy5hdHRyaWJ1dGVzLnB1c2goYXR0cmlidXRlKTtcbiAgfVxuXG4gIHJlcG9ydFN5bnRheEVycm9yKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgIGBTeW50YXggZXJyb3IgYXQgbGluZSAke3RoaXMudG9rZW5pemVyLmxpbmV9IGNvbCAke3RoaXMudG9rZW5pemVyLmNvbHVtbn06ICR7bWVzc2FnZX1gLFxuICAgICAgYi5sb2ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKVxuICAgICk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYXNzZW1ibGVBdHRyaWJ1dGVWYWx1ZShcbiAgcGFydHM6IChBU1QuTXVzdGFjaGVTdGF0ZW1lbnQgfCBBU1QuVGV4dE5vZGUpW10sXG4gIGlzUXVvdGVkOiBib29sZWFuLFxuICBpc0R5bmFtaWM6IGJvb2xlYW4sXG4gIGxpbmU6IG51bWJlclxuKSB7XG4gIGlmIChpc0R5bmFtaWMpIHtcbiAgICBpZiAoaXNRdW90ZWQpIHtcbiAgICAgIHJldHVybiBhc3NlbWJsZUNvbmNhdGVuYXRlZFZhbHVlKHBhcnRzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKFxuICAgICAgICBwYXJ0cy5sZW5ndGggPT09IDEgfHxcbiAgICAgICAgKHBhcnRzLmxlbmd0aCA9PT0gMiAmJlxuICAgICAgICAgIHBhcnRzWzFdLnR5cGUgPT09ICdUZXh0Tm9kZScgJiZcbiAgICAgICAgICAocGFydHNbMV0gYXMgQVNULlRleHROb2RlKS5jaGFycyA9PT0gJy8nKVxuICAgICAgKSB7XG4gICAgICAgIHJldHVybiBwYXJ0c1swXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgICAgICBgQW4gdW5xdW90ZWQgYXR0cmlidXRlIHZhbHVlIG11c3QgYmUgYSBzdHJpbmcgb3IgYSBtdXN0YWNoZSwgYCArXG4gICAgICAgICAgICBgcHJlY2VlZGVkIGJ5IHdoaXRlc3BhY2Ugb3IgYSAnPScgY2hhcmFjdGVyLCBhbmQgYCArXG4gICAgICAgICAgICBgZm9sbG93ZWQgYnkgd2hpdGVzcGFjZSwgYSAnPicgY2hhcmFjdGVyLCBvciAnLz4nIChvbiBsaW5lICR7bGluZX0pYCxcbiAgICAgICAgICBiLmxvYyhsaW5lLCAwKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gcGFydHMubGVuZ3RoID4gMCA/IHBhcnRzWzBdIDogYi50ZXh0KCcnKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NlbWJsZUNvbmNhdGVuYXRlZFZhbHVlKHBhcnRzOiAoQVNULk11c3RhY2hlU3RhdGVtZW50IHwgQVNULlRleHROb2RlKVtdKSB7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgcGFydDogQVNULkJhc2VOb2RlID0gcGFydHNbaV07XG5cbiAgICBpZiAocGFydC50eXBlICE9PSAnTXVzdGFjaGVTdGF0ZW1lbnQnICYmIHBhcnQudHlwZSAhPT0gJ1RleHROb2RlJykge1xuICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgICAnVW5zdXBwb3J0ZWQgbm9kZSBpbiBxdW90ZWQgYXR0cmlidXRlIHZhbHVlOiAnICsgcGFydFsndHlwZSddLFxuICAgICAgICBwYXJ0LmxvY1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gYi5jb25jYXQocGFydHMpO1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUVuZFRhZyhcbiAgdGFnOiBUYWc8J1N0YXJ0VGFnJyB8ICdFbmRUYWcnPixcbiAgZWxlbWVudDogQVNULkVsZW1lbnROb2RlLFxuICBzZWxmQ2xvc2luZzogYm9vbGVhblxuKSB7XG4gIGxldCBlcnJvcjtcblxuICBpZiAodm9pZE1hcFt0YWcubmFtZV0gJiYgIXNlbGZDbG9zaW5nKSB7XG4gICAgLy8gRW5nVGFnIGlzIGFsc28gY2FsbGVkIGJ5IFN0YXJ0VGFnIGZvciB2b2lkIGFuZCBzZWxmLWNsb3NpbmcgdGFncyAoaS5lLlxuICAgIC8vIDxpbnB1dD4gb3IgPGJyIC8+LCBzbyB3ZSBuZWVkIHRvIGNoZWNrIGZvciB0aGF0IGhlcmUuIE90aGVyd2lzZSwgd2Ugd291bGRcbiAgICAvLyB0aHJvdyBhbiBlcnJvciBmb3IgdGhvc2UgY2FzZXMuXG4gICAgZXJyb3IgPSAnSW52YWxpZCBlbmQgdGFnICcgKyBmb3JtYXRFbmRUYWdJbmZvKHRhZykgKyAnICh2b2lkIGVsZW1lbnRzIGNhbm5vdCBoYXZlIGVuZCB0YWdzKS4nO1xuICB9IGVsc2UgaWYgKGVsZW1lbnQudGFnID09PSB1bmRlZmluZWQpIHtcbiAgICBlcnJvciA9ICdDbG9zaW5nIHRhZyAnICsgZm9ybWF0RW5kVGFnSW5mbyh0YWcpICsgJyB3aXRob3V0IGFuIG9wZW4gdGFnLic7XG4gIH0gZWxzZSBpZiAoZWxlbWVudC50YWcgIT09IHRhZy5uYW1lKSB7XG4gICAgZXJyb3IgPVxuICAgICAgJ0Nsb3NpbmcgdGFnICcgK1xuICAgICAgZm9ybWF0RW5kVGFnSW5mbyh0YWcpICtcbiAgICAgICcgZGlkIG5vdCBtYXRjaCBsYXN0IG9wZW4gdGFnIGAnICtcbiAgICAgIGVsZW1lbnQudGFnICtcbiAgICAgICdgIChvbiBsaW5lICcgK1xuICAgICAgZWxlbWVudC5sb2Muc3RhcnQubGluZSArXG4gICAgICAnKS4nO1xuICB9XG5cbiAgaWYgKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGVycm9yLCBlbGVtZW50LmxvYyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZm9ybWF0RW5kVGFnSW5mbyh0YWc6IFRhZzwnU3RhcnRUYWcnIHwgJ0VuZFRhZyc+KSB7XG4gIHJldHVybiAnYCcgKyB0YWcubmFtZSArICdgIChvbiBsaW5lICcgKyB0YWcubG9jLmVuZC5saW5lICsgJyknO1xufVxuXG4vKipcbiAgQVNUUGx1Z2lucyBjYW4gbWFrZSBjaGFuZ2VzIHRvIHRoZSBHbGltbWVyIHRlbXBsYXRlIEFTVCBiZWZvcmVcbiAgY29tcGlsYXRpb24gYmVnaW5zLlxuKi9cbmV4cG9ydCBpbnRlcmZhY2UgQVNUUGx1Z2luQnVpbGRlciB7XG4gIChlbnY6IEFTVFBsdWdpbkVudmlyb25tZW50KTogQVNUUGx1Z2luO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFTVFBsdWdpbiB7XG4gIG5hbWU6IHN0cmluZztcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3I7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQVNUUGx1Z2luRW52aXJvbm1lbnQge1xuICBtZXRhPzogb2JqZWN0O1xuICBzeW50YXg6IFN5bnRheDtcbn1cbmludGVyZmFjZSBIYW5kbGViYXJzUGFyc2VPcHRpb25zIHtcbiAgc3JjTmFtZT86IHN0cmluZztcbiAgaWdub3JlU3RhbmRhbG9uZT86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJlcHJvY2Vzc09wdGlvbnMge1xuICBtZXRhPzogdW5rbm93bjtcbiAgcGx1Z2lucz86IHtcbiAgICBhc3Q/OiBBU1RQbHVnaW5CdWlsZGVyW107XG4gIH07XG4gIHBhcnNlT3B0aW9ucz86IEhhbmRsZWJhcnNQYXJzZU9wdGlvbnM7XG5cbiAgLyoqXG4gICAgVXNlZnVsIGZvciBzcGVjaWZ5aW5nIGEgZ3JvdXAgb2Ygb3B0aW9ucyB0b2dldGhlci5cblxuICAgIFdoZW4gYCdjb2RlbW9kJ2Agd2UgZGlzYWJsZSBhbGwgd2hpdGVzcGFjZSBjb250cm9sIGluIGhhbmRsZWJhcnNcbiAgICAodG8gcHJlc2VydmUgYXMgbXVjaCBhcyBwb3NzaWJsZSkgYW5kIHdlIGFsc28gYXZvaWQgYW55XG4gICAgZXNjYXBpbmcvdW5lc2NhcGluZyBvZiBIVE1MIGVudGl0eSBjb2Rlcy5cbiAgICovXG4gIG1vZGU/OiAnY29kZW1vZCcgfCAncHJlY29tcGlsZSc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3ludGF4IHtcbiAgcGFyc2U6IHR5cGVvZiBwcmVwcm9jZXNzO1xuICBidWlsZGVyczogdHlwZW9mIGJ1aWxkZXJzO1xuICBwcmludDogdHlwZW9mIHByaW50O1xuICB0cmF2ZXJzZTogdHlwZW9mIHRyYXZlcnNlO1xuICBXYWxrZXI6IHR5cGVvZiBXYWxrZXI7XG59XG5cbmNvbnN0IHN5bnRheDogU3ludGF4ID0ge1xuICBwYXJzZTogcHJlcHJvY2VzcyxcbiAgYnVpbGRlcnMsXG4gIHByaW50LFxuICB0cmF2ZXJzZSxcbiAgV2Fsa2VyLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHByZXByb2Nlc3MoaHRtbDogc3RyaW5nLCBvcHRpb25zOiBQcmVwcm9jZXNzT3B0aW9ucyA9IHt9KTogQVNULlRlbXBsYXRlIHtcbiAgbGV0IG1vZGUgPSBvcHRpb25zLm1vZGUgfHwgJ3ByZWNvbXBpbGUnO1xuXG4gIGxldCBhc3Q6IEhCUy5Qcm9ncmFtO1xuICBpZiAodHlwZW9mIGh0bWwgPT09ICdvYmplY3QnKSB7XG4gICAgYXN0ID0gaHRtbDtcbiAgfSBlbHNlIGlmIChtb2RlID09PSAnY29kZW1vZCcpIHtcbiAgICBhc3QgPSBoYW5kbGViYXJzLnBhcnNlV2l0aG91dFByb2Nlc3NpbmcoaHRtbCwgb3B0aW9ucy5wYXJzZU9wdGlvbnMpIGFzIEhCUy5Qcm9ncmFtO1xuICB9IGVsc2Uge1xuICAgIGFzdCA9IGhhbmRsZWJhcnMucGFyc2UoaHRtbCwgb3B0aW9ucy5wYXJzZU9wdGlvbnMpIGFzIEhCUy5Qcm9ncmFtO1xuICB9XG5cbiAgbGV0IGVudGl0eVBhcnNlciA9IHVuZGVmaW5lZDtcbiAgaWYgKG1vZGUgPT09ICdjb2RlbW9kJykge1xuICAgIGVudGl0eVBhcnNlciA9IG5ldyBFbnRpdHlQYXJzZXIoe30pO1xuICB9XG5cbiAgbGV0IHByb2dyYW0gPSBuZXcgVG9rZW5pemVyRXZlbnRIYW5kbGVycyhodG1sLCBlbnRpdHlQYXJzZXIpLmFjY2VwdFRlbXBsYXRlKGFzdCk7XG5cbiAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wbHVnaW5zICYmIG9wdGlvbnMucGx1Z2lucy5hc3QpIHtcbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IG9wdGlvbnMucGx1Z2lucy5hc3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICBsZXQgdHJhbnNmb3JtID0gb3B0aW9ucy5wbHVnaW5zLmFzdFtpXTtcbiAgICAgIGxldCBlbnYgPSBhc3NpZ24oe30sIG9wdGlvbnMsIHsgc3ludGF4IH0sIHsgcGx1Z2luczogdW5kZWZpbmVkIH0pO1xuXG4gICAgICBsZXQgcGx1Z2luUmVzdWx0ID0gdHJhbnNmb3JtKGVudik7XG5cbiAgICAgIHRyYXZlcnNlKHByb2dyYW0sIHBsdWdpblJlc3VsdC52aXNpdG9yKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcHJvZ3JhbTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=