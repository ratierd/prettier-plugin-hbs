import { isDestroyable, isStringDestroyable, DESTROY } from './destroy';

import { symbol } from './platform-utils';
export const LINKED = new WeakMap();
export const WILL_DROP = symbol('WILL_DROP');
export const DID_DROP = symbol('DID_DROP');
export const CHILDREN = symbol('CHILDREN');
export const DESTRUCTORS = new WeakMap();
export function isDrop(value) {
    if (value === null || typeof value !== 'object') return false;
    return value[DID_DROP] !== undefined;
}
export function associate(parent, child) {
    associateDestructor(parent, destructor(child));
}
export function associateDestructor(parent, child) {
    let associated = LINKED.get(parent);
    if (!associated) {
        associated = new Set();
        LINKED.set(parent, associated);
    }
    associated.add(child);
}
export function peekAssociated(parent) {
    return LINKED.get(parent) || null;
}
export function takeAssociated(parent) {
    let linked = LINKED.get(parent);
    if (linked && linked.size > 0) {
        LINKED.delete(parent);
        return linked;
    } else {
        return null;
    }
}
export function willDestroyAssociated(parent) {
    let associated = LINKED.get(parent);
    if (associated) {
        associated.forEach(item => {
            item[WILL_DROP]();
        });
    }
}
export function didDestroyAssociated(parent) {
    let associated = LINKED.get(parent);
    if (associated) {
        associated.forEach(item => {
            item[DID_DROP]();
            associated.delete(item);
        });
    }
}
export function destructor(value) {
    let d = DESTRUCTORS.get(value);
    if (!d) {
        if (isDestroyable(value)) {
            d = new DestroyableDestructor(value);
        } else if (isStringDestroyable(value)) {
            d = new StringDestroyableDestructor(value);
        } else {
            d = new SimpleDestructor(value);
        }
        DESTRUCTORS.set(value, d);
    }
    return d;
}
export function snapshot(values) {
    return new SnapshotDestructor(values);
}
class SnapshotDestructor {
    constructor(destructors) {
        this.destructors = destructors;
    }
    [WILL_DROP]() {
        this.destructors.forEach(item => item[WILL_DROP]());
    }
    [DID_DROP]() {
        this.destructors.forEach(item => item[DID_DROP]());
    }
    get [CHILDREN]() {
        return this.destructors;
    }
    toString() {
        return 'SnapshotDestructor';
    }
}
class DestroyableDestructor {
    constructor(inner) {
        this.inner = inner;
    }
    [WILL_DROP]() {
        willDestroyAssociated(this.inner);
    }
    [DID_DROP]() {
        this.inner[DESTROY]();
        didDestroyAssociated(this.inner);
    }
    get [CHILDREN]() {
        return LINKED.get(this.inner) || [];
    }
    toString() {
        return 'DestroyableDestructor';
    }
}
class StringDestroyableDestructor {
    constructor(inner) {
        this.inner = inner;
    }
    [WILL_DROP]() {
        if (typeof this.inner.willDestroy === 'function') {
            this.inner.willDestroy();
        }
        willDestroyAssociated(this.inner);
    }
    [DID_DROP]() {
        this.inner.destroy();
        didDestroyAssociated(this.inner);
    }
    get [CHILDREN]() {
        return LINKED.get(this.inner) || [];
    }
    toString() {
        return 'StringDestroyableDestructor';
    }
}
class SimpleDestructor {
    constructor(inner) {
        this.inner = inner;
    }
    [WILL_DROP]() {
        willDestroyAssociated(this.inner);
    }
    [DID_DROP]() {
        didDestroyAssociated(this.inner);
    }
    get [CHILDREN]() {
        return LINKED.get(this.inner) || [];
    }
    toString() {
        return 'SimpleDestructor';
    }
}
export class ListContentsDestructor {
    constructor(inner) {
        this.inner = inner;
    }
    [WILL_DROP]() {
        this.inner.forEachNode(d => destructor(d)[WILL_DROP]());
    }
    [DID_DROP]() {
        this.inner.forEachNode(d => destructor(d)[DID_DROP]());
    }
    get [CHILDREN]() {
        let out = [];
        this.inner.forEachNode(d => out.push(...destructor(d)[CHILDREN]));
        return out;
    }
    toString() {
        return 'ListContentsDestructor';
    }
}
export function debugDropTree(inner) {
    let hasDrop = isDrop(inner);
    let rawChildren = LINKED.get(inner) || null;
    let children = null;
    if (rawChildren) {
        children = [];
        for (let child of rawChildren) {
            children.push(debugDropTree(child));
        }
    }
    let obj = Object.create(null);
    obj.inner = inner;
    if (children) {
        obj.children = children;
    }
    obj.hasDrop = hasDrop;
    return obj;
}
export function printDropTree(inner) {
    printDrop(destructor(inner));
}
export function printDrop(inner) {
    console.group(String(inner));
    console.log(inner);
    let children = inner[CHILDREN] || null;
    if (children) {
        for (let child of children) {
            printDrop(child);
        }
    }
    console.groupEnd();
}
if (false /* LOCAL_DEBUG */ && typeof window !== 'undefined') {
    window.PRINT_DROP = printDropTree;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3V0aWwvbGliL2xpZmV0aW1lcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTLGFBQVQsRUFBd0IsbUJBQXhCLEVBQTZDLE9BQTdDLFFBQTRELFdBQTVEOztBQVlBLFNBQVMsTUFBVCxRQUF1QixrQkFBdkI7QUFFQSxPQUFPLE1BQU0sU0FBcUMsSUFBSSxPQUFKLEVBQTNDO0FBQ1AsT0FBTyxNQUFNLFlBQTRCLE9BQU8sV0FBUCxDQUFsQztBQUNQLE9BQU8sTUFBTSxXQUEwQixPQUFPLFVBQVAsQ0FBaEM7QUFDUCxPQUFPLE1BQU0sV0FBMkIsT0FBTyxVQUFQLENBQWpDO0FBQ1AsT0FBTyxNQUFNLGNBQWMsSUFBSSxPQUFKLEVBQXBCO0FBRVAsT0FBTSxTQUFVLE1BQVYsQ0FBaUIsS0FBakIsRUFBK0I7QUFDbkMsUUFBSSxVQUFVLElBQVYsSUFBa0IsT0FBTyxLQUFQLEtBQWlCLFFBQXZDLEVBQWlELE9BQU8sS0FBUDtBQUNqRCxXQUFRLE1BQWUsUUFBZixNQUE2QixTQUFyQztBQUNEO0FBRUQsT0FBTSxTQUFVLFNBQVYsQ0FBb0IsTUFBcEIsRUFBb0MsS0FBcEMsRUFBaUQ7QUFDckQsd0JBQW9CLE1BQXBCLEVBQTRCLFdBQVcsS0FBWCxDQUE1QjtBQUNEO0FBRUQsT0FBTSxTQUFVLG1CQUFWLENBQThCLE1BQTlCLEVBQThDLEtBQTlDLEVBQXlEO0FBQzdELFFBQUksYUFBYSxPQUFPLEdBQVAsQ0FBVyxNQUFYLENBQWpCO0FBRUEsUUFBSSxDQUFDLFVBQUwsRUFBaUI7QUFDZixxQkFBYSxJQUFJLEdBQUosRUFBYjtBQUNBLGVBQU8sR0FBUCxDQUFXLE1BQVgsRUFBbUIsVUFBbkI7QUFDRDtBQUVELGVBQVcsR0FBWCxDQUFlLEtBQWY7QUFDRDtBQUVELE9BQU0sU0FBVSxjQUFWLENBQXlCLE1BQXpCLEVBQXVDO0FBQzNDLFdBQU8sT0FBTyxHQUFQLENBQVcsTUFBWCxLQUFzQixJQUE3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QTRCLGFBQTVCO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc0Rlc3Ryb3lhYmxlLCBpc1N0cmluZ0Rlc3Ryb3lhYmxlLCBERVNUUk9ZIH0gZnJvbSAnLi9kZXN0cm95JztcbmltcG9ydCB7XG4gIE9wdGlvbixcbiAgU3ltYm9sRGVzdHJveWFibGUsXG4gIERlc3Ryb3lhYmxlLFxuICBEcm9wLFxuICBXaWxsRHJvcFN5bWJvbCxcbiAgRGlkRHJvcFN5bWJvbCxcbiAgQ2hpbGRyZW5TeW1ib2wsXG59IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgTGlua2VkTGlzdCwgTGlua2VkTGlzdE5vZGUgfSBmcm9tICcuL2xpc3QtdXRpbHMnO1xuaW1wb3J0IHsgTE9DQUxfREVCVUcgfSBmcm9tICdAZ2xpbW1lci9sb2NhbC1kZWJ1Zy1mbGFncyc7XG5pbXBvcnQgeyBzeW1ib2wgfSBmcm9tICcuL3BsYXRmb3JtLXV0aWxzJztcblxuZXhwb3J0IGNvbnN0IExJTktFRDogV2Vha01hcDxvYmplY3QsIFNldDxEcm9wPj4gPSBuZXcgV2Vha01hcCgpO1xuZXhwb3J0IGNvbnN0IFdJTExfRFJPUDogV2lsbERyb3BTeW1ib2wgPSBzeW1ib2woJ1dJTExfRFJPUCcpO1xuZXhwb3J0IGNvbnN0IERJRF9EUk9QOiBEaWREcm9wU3ltYm9sID0gc3ltYm9sKCdESURfRFJPUCcpO1xuZXhwb3J0IGNvbnN0IENISUxEUkVOOiBDaGlsZHJlblN5bWJvbCA9IHN5bWJvbCgnQ0hJTERSRU4nKTtcbmV4cG9ydCBjb25zdCBERVNUUlVDVE9SUyA9IG5ldyBXZWFrTWFwKCk7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0Ryb3AodmFsdWU6IHVua25vd24pOiB2YWx1ZSBpcyBEcm9wIHtcbiAgaWYgKHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSAhPT0gJ29iamVjdCcpIHJldHVybiBmYWxzZTtcbiAgcmV0dXJuICh2YWx1ZSBhcyBEcm9wKVtESURfRFJPUF0gIT09IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFzc29jaWF0ZShwYXJlbnQ6IG9iamVjdCwgY2hpbGQ6IG9iamVjdCkge1xuICBhc3NvY2lhdGVEZXN0cnVjdG9yKHBhcmVudCwgZGVzdHJ1Y3RvcihjaGlsZCkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXNzb2NpYXRlRGVzdHJ1Y3RvcihwYXJlbnQ6IG9iamVjdCwgY2hpbGQ6IERyb3ApOiB2b2lkIHtcbiAgbGV0IGFzc29jaWF0ZWQgPSBMSU5LRUQuZ2V0KHBhcmVudCk7XG5cbiAgaWYgKCFhc3NvY2lhdGVkKSB7XG4gICAgYXNzb2NpYXRlZCA9IG5ldyBTZXQoKTtcbiAgICBMSU5LRUQuc2V0KHBhcmVudCwgYXNzb2NpYXRlZCk7XG4gIH1cblxuICBhc3NvY2lhdGVkLmFkZChjaGlsZCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZWVrQXNzb2NpYXRlZChwYXJlbnQ6IG9iamVjdCk6IE9wdGlvbjxTZXQ8RHJvcD4+IHtcbiAgcmV0dXJuIExJTktFRC5nZXQocGFyZW50KSB8fCBudWxsO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdGFrZUFzc29jaWF0ZWQocGFyZW50OiBvYmplY3QpOiBPcHRpb248U2V0PERyb3A+PiB7XG4gIGxldCBsaW5rZWQgPSBMSU5LRUQuZ2V0KHBhcmVudCk7XG5cbiAgaWYgKGxpbmtlZCAmJiBsaW5rZWQuc2l6ZSA+IDApIHtcbiAgICBMSU5LRUQuZGVsZXRlKHBhcmVudCk7XG4gICAgcmV0dXJuIGxpbmtlZDtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gd2lsbERlc3Ryb3lBc3NvY2lhdGVkKHBhcmVudDogb2JqZWN0KSB7XG4gIGxldCBhc3NvY2lhdGVkID0gTElOS0VELmdldChwYXJlbnQpO1xuXG4gIGlmIChhc3NvY2lhdGVkKSB7XG4gICAgYXNzb2NpYXRlZC5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgaXRlbVtXSUxMX0RST1BdKCk7XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRpZERlc3Ryb3lBc3NvY2lhdGVkKHBhcmVudDogb2JqZWN0KSB7XG4gIGxldCBhc3NvY2lhdGVkID0gTElOS0VELmdldChwYXJlbnQpO1xuXG4gIGlmIChhc3NvY2lhdGVkKSB7XG4gICAgYXNzb2NpYXRlZC5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgaXRlbVtESURfRFJPUF0oKTtcbiAgICAgIGFzc29jaWF0ZWQhLmRlbGV0ZShpdGVtKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVzdHJ1Y3Rvcih2YWx1ZTogb2JqZWN0KTogRHJvcCB7XG4gIGxldCBkID0gREVTVFJVQ1RPUlMuZ2V0KHZhbHVlKTtcblxuICBpZiAoIWQpIHtcbiAgICBpZiAoaXNEZXN0cm95YWJsZSh2YWx1ZSkpIHtcbiAgICAgIGQgPSBuZXcgRGVzdHJveWFibGVEZXN0cnVjdG9yKHZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKGlzU3RyaW5nRGVzdHJveWFibGUodmFsdWUpKSB7XG4gICAgICBkID0gbmV3IFN0cmluZ0Rlc3Ryb3lhYmxlRGVzdHJ1Y3Rvcih2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGQgPSBuZXcgU2ltcGxlRGVzdHJ1Y3Rvcih2YWx1ZSk7XG4gICAgfVxuXG4gICAgREVTVFJVQ1RPUlMuc2V0KHZhbHVlLCBkKTtcbiAgfVxuXG4gIHJldHVybiBkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc25hcHNob3QodmFsdWVzOiBTZXQ8RHJvcD4pOiBEcm9wIHtcbiAgcmV0dXJuIG5ldyBTbmFwc2hvdERlc3RydWN0b3IodmFsdWVzKTtcbn1cblxuY2xhc3MgU25hcHNob3REZXN0cnVjdG9yIGltcGxlbWVudHMgRHJvcCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZGVzdHJ1Y3RvcnM6IFNldDxEcm9wPikge31cblxuICBbV0lMTF9EUk9QXSgpIHtcbiAgICB0aGlzLmRlc3RydWN0b3JzLmZvckVhY2goaXRlbSA9PiBpdGVtW1dJTExfRFJPUF0oKSk7XG4gIH1cblxuICBbRElEX0RST1BdKCkge1xuICAgIHRoaXMuZGVzdHJ1Y3RvcnMuZm9yRWFjaChpdGVtID0+IGl0ZW1bRElEX0RST1BdKCkpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIHJldHVybiB0aGlzLmRlc3RydWN0b3JzO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuICdTbmFwc2hvdERlc3RydWN0b3InO1xuICB9XG59XG5cbmNsYXNzIERlc3Ryb3lhYmxlRGVzdHJ1Y3RvciBpbXBsZW1lbnRzIERyb3Age1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGlubmVyOiBTeW1ib2xEZXN0cm95YWJsZSkge31cblxuICBbV0lMTF9EUk9QXSgpIHtcbiAgICB3aWxsRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBbRElEX0RST1BdKCkge1xuICAgIHRoaXMuaW5uZXJbREVTVFJPWV0oKTtcbiAgICBkaWREZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICByZXR1cm4gTElOS0VELmdldCh0aGlzLmlubmVyKSB8fCBbXTtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnRGVzdHJveWFibGVEZXN0cnVjdG9yJztcbiAgfVxufVxuXG5jbGFzcyBTdHJpbmdEZXN0cm95YWJsZURlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogRGVzdHJveWFibGUpIHt9XG5cbiAgW1dJTExfRFJPUF0oKSB7XG4gICAgaWYgKHR5cGVvZiB0aGlzLmlubmVyLndpbGxEZXN0cm95ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aGlzLmlubmVyLndpbGxEZXN0cm95KCk7XG4gICAgfVxuICAgIHdpbGxEZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIFtESURfRFJPUF0oKSB7XG4gICAgdGhpcy5pbm5lci5kZXN0cm95KCk7XG4gICAgZGlkRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBnZXQgW0NISUxEUkVOXSgpOiBJdGVyYWJsZTxEcm9wPiB7XG4gICAgcmV0dXJuIExJTktFRC5nZXQodGhpcy5pbm5lcikgfHwgW107XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gJ1N0cmluZ0Rlc3Ryb3lhYmxlRGVzdHJ1Y3Rvcic7XG4gIH1cbn1cblxuY2xhc3MgU2ltcGxlRGVzdHJ1Y3RvciBpbXBsZW1lbnRzIERyb3Age1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGlubmVyOiBvYmplY3QpIHt9XG5cbiAgW1dJTExfRFJPUF0oKSB7XG4gICAgd2lsbERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgW0RJRF9EUk9QXSgpIHtcbiAgICBkaWREZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICByZXR1cm4gTElOS0VELmdldCh0aGlzLmlubmVyKSB8fCBbXTtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnU2ltcGxlRGVzdHJ1Y3Rvcic7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIExpc3RDb250ZW50c0Rlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogTGlua2VkTGlzdDxMaW5rZWRMaXN0Tm9kZT4pIHt9XG5cbiAgW1dJTExfRFJPUF0oKSB7XG4gICAgdGhpcy5pbm5lci5mb3JFYWNoTm9kZShkID0+IGRlc3RydWN0b3IoZClbV0lMTF9EUk9QXSgpKTtcbiAgfVxuXG4gIFtESURfRFJPUF0oKSB7XG4gICAgdGhpcy5pbm5lci5mb3JFYWNoTm9kZShkID0+IGRlc3RydWN0b3IoZClbRElEX0RST1BdKCkpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIGxldCBvdXQ6IERyb3BbXSA9IFtdO1xuICAgIHRoaXMuaW5uZXIuZm9yRWFjaE5vZGUoZCA9PiBvdXQucHVzaCguLi5kZXN0cnVjdG9yKGQpW0NISUxEUkVOXSkpO1xuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gJ0xpc3RDb250ZW50c0Rlc3RydWN0b3InO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGVidWdOb2RlIHtcbiAgaW5uZXI6IG9iamVjdDtcbiAgY2hpbGRyZW46IERlYnVnTm9kZVtdIHwgbnVsbDtcbiAgaGFzRHJvcDogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYnVnRHJvcFRyZWUoaW5uZXI6IG9iamVjdCk6IERlYnVnTm9kZSB7XG4gIGxldCBoYXNEcm9wID0gaXNEcm9wKGlubmVyKTtcbiAgbGV0IHJhd0NoaWxkcmVuID0gTElOS0VELmdldChpbm5lcikgfHwgbnVsbDtcbiAgbGV0IGNoaWxkcmVuOiBEZWJ1Z05vZGVbXSB8IG51bGwgPSBudWxsO1xuXG4gIGlmIChyYXdDaGlsZHJlbikge1xuICAgIGNoaWxkcmVuID0gW107XG4gICAgZm9yIChsZXQgY2hpbGQgb2YgcmF3Q2hpbGRyZW4pIHtcbiAgICAgIGNoaWxkcmVuLnB1c2goZGVidWdEcm9wVHJlZShjaGlsZCkpO1xuICAgIH1cbiAgfVxuXG4gIGxldCBvYmogPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICBvYmouaW5uZXIgPSBpbm5lcjtcbiAgaWYgKGNoaWxkcmVuKSB7XG4gICAgb2JqLmNoaWxkcmVuID0gY2hpbGRyZW47XG4gIH1cbiAgb2JqLmhhc0Ryb3AgPSBoYXNEcm9wO1xuICByZXR1cm4gb2JqO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJpbnREcm9wVHJlZShpbm5lcjogb2JqZWN0KSB7XG4gIHByaW50RHJvcChkZXN0cnVjdG9yKGlubmVyKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmludERyb3AoaW5uZXI6IERyb3ApIHtcbiAgY29uc29sZS5ncm91cChTdHJpbmcoaW5uZXIpKTtcblxuICBjb25zb2xlLmxvZyhpbm5lcik7XG5cbiAgbGV0IGNoaWxkcmVuID0gaW5uZXJbQ0hJTERSRU5dIHx8IG51bGw7XG4gIGlmIChjaGlsZHJlbikge1xuICAgIGZvciAobGV0IGNoaWxkIG9mIGNoaWxkcmVuKSB7XG4gICAgICBwcmludERyb3AoY2hpbGQpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbn1cblxuaWYgKExPQ0FMX0RFQlVHICYmIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XG4gICh3aW5kb3cgYXMgYW55KS5QUklOVF9EUk9QID0gcHJpbnREcm9wVHJlZTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=