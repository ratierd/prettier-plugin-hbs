"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.ListContentsDestructor = exports.DESTRUCTORS = exports.CHILDREN = exports.DID_DROP = exports.WILL_DROP = exports.LINKED = undefined;
exports.isDrop = isDrop;
exports.associate = associate;
exports.associateDestructor = associateDestructor;
exports.peekAssociated = peekAssociated;
exports.takeAssociated = takeAssociated;
exports.willDestroyAssociated = willDestroyAssociated;
exports.didDestroyAssociated = didDestroyAssociated;
exports.destructor = destructor;
exports.snapshot = snapshot;
exports.debugDropTree = debugDropTree;
exports.printDropTree = printDropTree;
exports.printDrop = printDrop;

var _destroy = require("./destroy");

var _platformUtils = require("./platform-utils");

var _createClass = function () {
    function defineProperties(target, props) {
        for (var i = 0; i < props.length; i++) {
            var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ("value" in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);
        }
    }return function (Constructor, protoProps, staticProps) {
        if (protoProps) defineProperties(Constructor.prototype, protoProps);if (staticProps) defineProperties(Constructor, staticProps);return Constructor;
    };
}();

function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
        throw new TypeError("Cannot call a class as a function");
    }
}

var LINKED = exports.LINKED = new WeakMap();
var WILL_DROP = exports.WILL_DROP = (0, _platformUtils.symbol)('WILL_DROP');
var DID_DROP = exports.DID_DROP = (0, _platformUtils.symbol)('DID_DROP');
var CHILDREN = exports.CHILDREN = (0, _platformUtils.symbol)('CHILDREN');
var DESTRUCTORS = exports.DESTRUCTORS = new WeakMap();
function isDrop(value) {
    if (value === null || typeof value !== 'object') return false;
    return value[DID_DROP] !== undefined;
}
function associate(parent, child) {
    associateDestructor(parent, destructor(child));
}
function associateDestructor(parent, child) {
    var associated = LINKED.get(parent);
    if (!associated) {
        associated = new Set();
        LINKED.set(parent, associated);
    }
    associated.add(child);
}
function peekAssociated(parent) {
    return LINKED.get(parent) || null;
}
function takeAssociated(parent) {
    var linked = LINKED.get(parent);
    if (linked && linked.size > 0) {
        LINKED.delete(parent);
        return linked;
    } else {
        return null;
    }
}
function willDestroyAssociated(parent) {
    var associated = LINKED.get(parent);
    if (associated) {
        associated.forEach(function (item) {
            item[WILL_DROP]();
        });
    }
}
function didDestroyAssociated(parent) {
    var associated = LINKED.get(parent);
    if (associated) {
        associated.forEach(function (item) {
            item[DID_DROP]();
            associated.delete(item);
        });
    }
}
function destructor(value) {
    var d = DESTRUCTORS.get(value);
    if (!d) {
        if ((0, _destroy.isDestroyable)(value)) {
            d = new DestroyableDestructor(value);
        } else if ((0, _destroy.isStringDestroyable)(value)) {
            d = new StringDestroyableDestructor(value);
        } else {
            d = new SimpleDestructor(value);
        }
        DESTRUCTORS.set(value, d);
    }
    return d;
}
function snapshot(values) {
    return new SnapshotDestructor(values);
}

var SnapshotDestructor = function () {
    function SnapshotDestructor(destructors) {
        _classCallCheck(this, SnapshotDestructor);

        this.destructors = destructors;
    }

    SnapshotDestructor.prototype[WILL_DROP] = function () {
        this.destructors.forEach(function (item) {
            return item[WILL_DROP]();
        });
    };

    SnapshotDestructor.prototype[DID_DROP] = function () {
        this.destructors.forEach(function (item) {
            return item[DID_DROP]();
        });
    };

    SnapshotDestructor.prototype.toString = function toString() {
        return 'SnapshotDestructor';
    };

    _createClass(SnapshotDestructor, [{
        key: CHILDREN,
        get: function get() {
            return this.destructors;
        }
    }]);

    return SnapshotDestructor;
}();

var DestroyableDestructor = function () {
    function DestroyableDestructor(inner) {
        _classCallCheck(this, DestroyableDestructor);

        this.inner = inner;
    }

    DestroyableDestructor.prototype[WILL_DROP] = function () {
        willDestroyAssociated(this.inner);
    };

    DestroyableDestructor.prototype[DID_DROP] = function () {
        this.inner[_destroy.DESTROY]();
        didDestroyAssociated(this.inner);
    };

    DestroyableDestructor.prototype.toString = function toString() {
        return 'DestroyableDestructor';
    };

    _createClass(DestroyableDestructor, [{
        key: CHILDREN,
        get: function get() {
            return LINKED.get(this.inner) || [];
        }
    }]);

    return DestroyableDestructor;
}();

var StringDestroyableDestructor = function () {
    function StringDestroyableDestructor(inner) {
        _classCallCheck(this, StringDestroyableDestructor);

        this.inner = inner;
    }

    StringDestroyableDestructor.prototype[WILL_DROP] = function () {
        if (typeof this.inner.willDestroy === 'function') {
            this.inner.willDestroy();
        }
        willDestroyAssociated(this.inner);
    };

    StringDestroyableDestructor.prototype[DID_DROP] = function () {
        this.inner.destroy();
        didDestroyAssociated(this.inner);
    };

    StringDestroyableDestructor.prototype.toString = function toString() {
        return 'StringDestroyableDestructor';
    };

    _createClass(StringDestroyableDestructor, [{
        key: CHILDREN,
        get: function get() {
            return LINKED.get(this.inner) || [];
        }
    }]);

    return StringDestroyableDestructor;
}();

var SimpleDestructor = function () {
    function SimpleDestructor(inner) {
        _classCallCheck(this, SimpleDestructor);

        this.inner = inner;
    }

    SimpleDestructor.prototype[WILL_DROP] = function () {
        willDestroyAssociated(this.inner);
    };

    SimpleDestructor.prototype[DID_DROP] = function () {
        didDestroyAssociated(this.inner);
    };

    SimpleDestructor.prototype.toString = function toString() {
        return 'SimpleDestructor';
    };

    _createClass(SimpleDestructor, [{
        key: CHILDREN,
        get: function get() {
            return LINKED.get(this.inner) || [];
        }
    }]);

    return SimpleDestructor;
}();

var ListContentsDestructor = exports.ListContentsDestructor = function () {
    function ListContentsDestructor(inner) {
        _classCallCheck(this, ListContentsDestructor);

        this.inner = inner;
    }

    ListContentsDestructor.prototype[WILL_DROP] = function () {
        this.inner.forEachNode(function (d) {
            return destructor(d)[WILL_DROP]();
        });
    };

    ListContentsDestructor.prototype[DID_DROP] = function () {
        this.inner.forEachNode(function (d) {
            return destructor(d)[DID_DROP]();
        });
    };

    ListContentsDestructor.prototype.toString = function toString() {
        return 'ListContentsDestructor';
    };

    _createClass(ListContentsDestructor, [{
        key: CHILDREN,
        get: function get() {
            var out = [];
            this.inner.forEachNode(function (d) {
                return out.push.apply(out, destructor(d)[CHILDREN]);
            });
            return out;
        }
    }]);

    return ListContentsDestructor;
}();
function debugDropTree(inner) {
    var hasDrop = isDrop(inner);
    var rawChildren = LINKED.get(inner) || null;
    var children = null;
    if (rawChildren) {
        children = [];
        for (var _iterator = rawChildren, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
            var _ref;

            if (_isArray) {
                if (_i >= _iterator.length) break;
                _ref = _iterator[_i++];
            } else {
                _i = _iterator.next();
                if (_i.done) break;
                _ref = _i.value;
            }

            var child = _ref;

            children.push(debugDropTree(child));
        }
    }
    var obj = Object.create(null);
    obj.inner = inner;
    if (children) {
        obj.children = children;
    }
    obj.hasDrop = hasDrop;
    return obj;
}
function printDropTree(inner) {
    printDrop(destructor(inner));
}
function printDrop(inner) {
    console.group(String(inner));
    console.log(inner);
    var children = inner[CHILDREN] || null;
    if (children) {
        for (var _iterator2 = children, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {
            var _ref2;

            if (_isArray2) {
                if (_i2 >= _iterator2.length) break;
                _ref2 = _iterator2[_i2++];
            } else {
                _i2 = _iterator2.next();
                if (_i2.done) break;
                _ref2 = _i2.value;
            }

            var child = _ref2;

            printDrop(child);
        }
    }
    console.groupEnd();
}
if (false /* LOCAL_DEBUG */ && typeof window !== 'undefined') {
    window.PRINT_DROP = printDropTree;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3V0aWwvbGliL2xpZmV0aW1lcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7UUFvQk0sTSxHQUFBLE07UUFLQSxTLEdBQUEsUztRQUlBLG1CLEdBQUEsbUI7UUFXQSxjLEdBQUEsYztRQUlBLGMsR0FBQSxjO1FBV0EscUIsR0FBQSxxQjtRQVVBLG9CLEdBQUEsb0I7UUFXQSxVLEdBQUEsVTtRQWtCQSxRLEdBQUEsUTtRQXFIQSxhLEdBQUEsYTtRQXFCQSxhLEdBQUEsYTtRQUlBLFMsR0FBQSxTOztBQTVPTjs7QUFZQTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRU8sSUFBTSwwQkFBcUMsSUFBM0MsT0FBMkMsRUFBM0M7QUFDQSxJQUFNLGdDQUE0QiwyQkFBbEMsV0FBa0MsQ0FBbEM7QUFDQSxJQUFNLDhCQUEwQiwyQkFBaEMsVUFBZ0MsQ0FBaEM7QUFDQSxJQUFNLDhCQUEyQiwyQkFBakMsVUFBaUMsQ0FBakM7QUFDQSxJQUFNLG9DQUFjLElBQXBCLE9BQW9CLEVBQXBCO0FBRUQsU0FBQSxNQUFBLENBQUEsS0FBQSxFQUErQjtBQUNuQyxRQUFJLFVBQUEsSUFBQSxJQUFrQixPQUFBLEtBQUEsS0FBdEIsUUFBQSxFQUFpRCxPQUFBLEtBQUE7QUFDakQsV0FBUSxNQUFBLFFBQUEsTUFBUixTQUFBO0FBQ0Q7QUFFSyxTQUFBLFNBQUEsQ0FBQSxNQUFBLEVBQUEsS0FBQSxFQUFpRDtBQUNyRCx3QkFBQSxNQUFBLEVBQTRCLFdBQTVCLEtBQTRCLENBQTVCO0FBQ0Q7QUFFSyxTQUFBLG1CQUFBLENBQUEsTUFBQSxFQUFBLEtBQUEsRUFBeUQ7QUFDN0QsUUFBSSxhQUFhLE9BQUEsR0FBQSxDQUFqQixNQUFpQixDQUFqQjtBQUVBLFFBQUksQ0FBSixVQUFBLEVBQWlCO0FBQ2YscUJBQWEsSUFBYixHQUFhLEVBQWI7QUFDQSxlQUFBLEdBQUEsQ0FBQSxNQUFBLEVBQUEsVUFBQTtBQUNEO0FBRUQsZUFBQSxH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O0FBQ0Q7QUFDRjtBQUVELFlBQUEsUUFBQTtBQUNEO0FBRUQsSUFBSSxNQUFBLGlCQUFBLElBQWUsT0FBQSxNQUFBLEtBQW5CLFdBQUEsRUFBa0Q7QUFDL0MsV0FBQSxVQUFBLEdBQUEsYUFBQTtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNEZXN0cm95YWJsZSwgaXNTdHJpbmdEZXN0cm95YWJsZSwgREVTVFJPWSB9IGZyb20gJy4vZGVzdHJveSc7XG5pbXBvcnQge1xuICBPcHRpb24sXG4gIFN5bWJvbERlc3Ryb3lhYmxlLFxuICBEZXN0cm95YWJsZSxcbiAgRHJvcCxcbiAgV2lsbERyb3BTeW1ib2wsXG4gIERpZERyb3BTeW1ib2wsXG4gIENoaWxkcmVuU3ltYm9sLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IExpbmtlZExpc3QsIExpbmtlZExpc3ROb2RlIH0gZnJvbSAnLi9saXN0LXV0aWxzJztcbmltcG9ydCB7IExPQ0FMX0RFQlVHIH0gZnJvbSAnQGdsaW1tZXIvbG9jYWwtZGVidWctZmxhZ3MnO1xuaW1wb3J0IHsgc3ltYm9sIH0gZnJvbSAnLi9wbGF0Zm9ybS11dGlscyc7XG5cbmV4cG9ydCBjb25zdCBMSU5LRUQ6IFdlYWtNYXA8b2JqZWN0LCBTZXQ8RHJvcD4+ID0gbmV3IFdlYWtNYXAoKTtcbmV4cG9ydCBjb25zdCBXSUxMX0RST1A6IFdpbGxEcm9wU3ltYm9sID0gc3ltYm9sKCdXSUxMX0RST1AnKTtcbmV4cG9ydCBjb25zdCBESURfRFJPUDogRGlkRHJvcFN5bWJvbCA9IHN5bWJvbCgnRElEX0RST1AnKTtcbmV4cG9ydCBjb25zdCBDSElMRFJFTjogQ2hpbGRyZW5TeW1ib2wgPSBzeW1ib2woJ0NISUxEUkVOJyk7XG5leHBvcnQgY29uc3QgREVTVFJVQ1RPUlMgPSBuZXcgV2Vha01hcCgpO1xuXG5leHBvcnQgZnVuY3Rpb24gaXNEcm9wKHZhbHVlOiB1bmtub3duKTogdmFsdWUgaXMgRHJvcCB7XG4gIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgIT09ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7XG4gIHJldHVybiAodmFsdWUgYXMgRHJvcClbRElEX0RST1BdICE9PSB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhc3NvY2lhdGUocGFyZW50OiBvYmplY3QsIGNoaWxkOiBvYmplY3QpIHtcbiAgYXNzb2NpYXRlRGVzdHJ1Y3RvcihwYXJlbnQsIGRlc3RydWN0b3IoY2hpbGQpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFzc29jaWF0ZURlc3RydWN0b3IocGFyZW50OiBvYmplY3QsIGNoaWxkOiBEcm9wKTogdm9pZCB7XG4gIGxldCBhc3NvY2lhdGVkID0gTElOS0VELmdldChwYXJlbnQpO1xuXG4gIGlmICghYXNzb2NpYXRlZCkge1xuICAgIGFzc29jaWF0ZWQgPSBuZXcgU2V0KCk7XG4gICAgTElOS0VELnNldChwYXJlbnQsIGFzc29jaWF0ZWQpO1xuICB9XG5cbiAgYXNzb2NpYXRlZC5hZGQoY2hpbGQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGVla0Fzc29jaWF0ZWQocGFyZW50OiBvYmplY3QpOiBPcHRpb248U2V0PERyb3A+PiB7XG4gIHJldHVybiBMSU5LRUQuZ2V0KHBhcmVudCkgfHwgbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRha2VBc3NvY2lhdGVkKHBhcmVudDogb2JqZWN0KTogT3B0aW9uPFNldDxEcm9wPj4ge1xuICBsZXQgbGlua2VkID0gTElOS0VELmdldChwYXJlbnQpO1xuXG4gIGlmIChsaW5rZWQgJiYgbGlua2VkLnNpemUgPiAwKSB7XG4gICAgTElOS0VELmRlbGV0ZShwYXJlbnQpO1xuICAgIHJldHVybiBsaW5rZWQ7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdpbGxEZXN0cm95QXNzb2NpYXRlZChwYXJlbnQ6IG9iamVjdCkge1xuICBsZXQgYXNzb2NpYXRlZCA9IExJTktFRC5nZXQocGFyZW50KTtcblxuICBpZiAoYXNzb2NpYXRlZCkge1xuICAgIGFzc29jaWF0ZWQuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGl0ZW1bV0lMTF9EUk9QXSgpO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkaWREZXN0cm95QXNzb2NpYXRlZChwYXJlbnQ6IG9iamVjdCkge1xuICBsZXQgYXNzb2NpYXRlZCA9IExJTktFRC5nZXQocGFyZW50KTtcblxuICBpZiAoYXNzb2NpYXRlZCkge1xuICAgIGFzc29jaWF0ZWQuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGl0ZW1bRElEX0RST1BdKCk7XG4gICAgICBhc3NvY2lhdGVkIS5kZWxldGUoaXRlbSk7XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlc3RydWN0b3IodmFsdWU6IG9iamVjdCk6IERyb3Age1xuICBsZXQgZCA9IERFU1RSVUNUT1JTLmdldCh2YWx1ZSk7XG5cbiAgaWYgKCFkKSB7XG4gICAgaWYgKGlzRGVzdHJveWFibGUodmFsdWUpKSB7XG4gICAgICBkID0gbmV3IERlc3Ryb3lhYmxlRGVzdHJ1Y3Rvcih2YWx1ZSk7XG4gICAgfSBlbHNlIGlmIChpc1N0cmluZ0Rlc3Ryb3lhYmxlKHZhbHVlKSkge1xuICAgICAgZCA9IG5ldyBTdHJpbmdEZXN0cm95YWJsZURlc3RydWN0b3IodmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBkID0gbmV3IFNpbXBsZURlc3RydWN0b3IodmFsdWUpO1xuICAgIH1cblxuICAgIERFU1RSVUNUT1JTLnNldCh2YWx1ZSwgZCk7XG4gIH1cblxuICByZXR1cm4gZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNuYXBzaG90KHZhbHVlczogU2V0PERyb3A+KTogRHJvcCB7XG4gIHJldHVybiBuZXcgU25hcHNob3REZXN0cnVjdG9yKHZhbHVlcyk7XG59XG5cbmNsYXNzIFNuYXBzaG90RGVzdHJ1Y3RvciBpbXBsZW1lbnRzIERyb3Age1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRlc3RydWN0b3JzOiBTZXQ8RHJvcD4pIHt9XG5cbiAgW1dJTExfRFJPUF0oKSB7XG4gICAgdGhpcy5kZXN0cnVjdG9ycy5mb3JFYWNoKGl0ZW0gPT4gaXRlbVtXSUxMX0RST1BdKCkpO1xuICB9XG5cbiAgW0RJRF9EUk9QXSgpIHtcbiAgICB0aGlzLmRlc3RydWN0b3JzLmZvckVhY2goaXRlbSA9PiBpdGVtW0RJRF9EUk9QXSgpKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICByZXR1cm4gdGhpcy5kZXN0cnVjdG9ycztcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnU25hcHNob3REZXN0cnVjdG9yJztcbiAgfVxufVxuXG5jbGFzcyBEZXN0cm95YWJsZURlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogU3ltYm9sRGVzdHJveWFibGUpIHt9XG5cbiAgW1dJTExfRFJPUF0oKSB7XG4gICAgd2lsbERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgW0RJRF9EUk9QXSgpIHtcbiAgICB0aGlzLmlubmVyW0RFU1RST1ldKCk7XG4gICAgZGlkRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBnZXQgW0NISUxEUkVOXSgpOiBJdGVyYWJsZTxEcm9wPiB7XG4gICAgcmV0dXJuIExJTktFRC5nZXQodGhpcy5pbm5lcikgfHwgW107XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gJ0Rlc3Ryb3lhYmxlRGVzdHJ1Y3Rvcic7XG4gIH1cbn1cblxuY2xhc3MgU3RyaW5nRGVzdHJveWFibGVEZXN0cnVjdG9yIGltcGxlbWVudHMgRHJvcCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5uZXI6IERlc3Ryb3lhYmxlKSB7fVxuXG4gIFtXSUxMX0RST1BdKCkge1xuICAgIGlmICh0eXBlb2YgdGhpcy5pbm5lci53aWxsRGVzdHJveSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5pbm5lci53aWxsRGVzdHJveSgpO1xuICAgIH1cbiAgICB3aWxsRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBbRElEX0RST1BdKCkge1xuICAgIHRoaXMuaW5uZXIuZGVzdHJveSgpO1xuICAgIGRpZERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIHJldHVybiBMSU5LRUQuZ2V0KHRoaXMuaW5uZXIpIHx8IFtdO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuICdTdHJpbmdEZXN0cm95YWJsZURlc3RydWN0b3InO1xuICB9XG59XG5cbmNsYXNzIFNpbXBsZURlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogb2JqZWN0KSB7fVxuXG4gIFtXSUxMX0RST1BdKCkge1xuICAgIHdpbGxEZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIFtESURfRFJPUF0oKSB7XG4gICAgZGlkRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBnZXQgW0NISUxEUkVOXSgpOiBJdGVyYWJsZTxEcm9wPiB7XG4gICAgcmV0dXJuIExJTktFRC5nZXQodGhpcy5pbm5lcikgfHwgW107XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gJ1NpbXBsZURlc3RydWN0b3InO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBMaXN0Q29udGVudHNEZXN0cnVjdG9yIGltcGxlbWVudHMgRHJvcCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5uZXI6IExpbmtlZExpc3Q8TGlua2VkTGlzdE5vZGU+KSB7fVxuXG4gIFtXSUxMX0RST1BdKCkge1xuICAgIHRoaXMuaW5uZXIuZm9yRWFjaE5vZGUoZCA9PiBkZXN0cnVjdG9yKGQpW1dJTExfRFJPUF0oKSk7XG4gIH1cblxuICBbRElEX0RST1BdKCkge1xuICAgIHRoaXMuaW5uZXIuZm9yRWFjaE5vZGUoZCA9PiBkZXN0cnVjdG9yKGQpW0RJRF9EUk9QXSgpKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICBsZXQgb3V0OiBEcm9wW10gPSBbXTtcbiAgICB0aGlzLmlubmVyLmZvckVhY2hOb2RlKGQgPT4gb3V0LnB1c2goLi4uZGVzdHJ1Y3RvcihkKVtDSElMRFJFTl0pKTtcbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuICdMaXN0Q29udGVudHNEZXN0cnVjdG9yJztcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIERlYnVnTm9kZSB7XG4gIGlubmVyOiBvYmplY3Q7XG4gIGNoaWxkcmVuOiBEZWJ1Z05vZGVbXSB8IG51bGw7XG4gIGhhc0Ryb3A6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWJ1Z0Ryb3BUcmVlKGlubmVyOiBvYmplY3QpOiBEZWJ1Z05vZGUge1xuICBsZXQgaGFzRHJvcCA9IGlzRHJvcChpbm5lcik7XG4gIGxldCByYXdDaGlsZHJlbiA9IExJTktFRC5nZXQoaW5uZXIpIHx8IG51bGw7XG4gIGxldCBjaGlsZHJlbjogRGVidWdOb2RlW10gfCBudWxsID0gbnVsbDtcblxuICBpZiAocmF3Q2hpbGRyZW4pIHtcbiAgICBjaGlsZHJlbiA9IFtdO1xuICAgIGZvciAobGV0IGNoaWxkIG9mIHJhd0NoaWxkcmVuKSB7XG4gICAgICBjaGlsZHJlbi5wdXNoKGRlYnVnRHJvcFRyZWUoY2hpbGQpKTtcbiAgICB9XG4gIH1cblxuICBsZXQgb2JqID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgb2JqLmlubmVyID0gaW5uZXI7XG4gIGlmIChjaGlsZHJlbikge1xuICAgIG9iai5jaGlsZHJlbiA9IGNoaWxkcmVuO1xuICB9XG4gIG9iai5oYXNEcm9wID0gaGFzRHJvcDtcbiAgcmV0dXJuIG9iajtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByaW50RHJvcFRyZWUoaW5uZXI6IG9iamVjdCkge1xuICBwcmludERyb3AoZGVzdHJ1Y3Rvcihpbm5lcikpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJpbnREcm9wKGlubmVyOiBEcm9wKSB7XG4gIGNvbnNvbGUuZ3JvdXAoU3RyaW5nKGlubmVyKSk7XG5cbiAgY29uc29sZS5sb2coaW5uZXIpO1xuXG4gIGxldCBjaGlsZHJlbiA9IGlubmVyW0NISUxEUkVOXSB8fCBudWxsO1xuICBpZiAoY2hpbGRyZW4pIHtcbiAgICBmb3IgKGxldCBjaGlsZCBvZiBjaGlsZHJlbikge1xuICAgICAgcHJpbnREcm9wKGNoaWxkKTtcbiAgICB9XG4gIH1cblxuICBjb25zb2xlLmdyb3VwRW5kKCk7XG59XG5cbmlmIChMT0NBTF9ERUJVRyAmJiB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAod2luZG93IGFzIGFueSkuUFJJTlRfRFJPUCA9IHByaW50RHJvcFRyZWU7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9